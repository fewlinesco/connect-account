' ###############################################################################
' ########### HERE IS THE LIST OF DIAGRAMS USED FOR THE DOCUMENTATION ###########
' ###############################################################################


' ===========================================================
' ======================= OAuth2 flow =======================
' ===========================================================

@startuml

skinparam NoteBackgroundColor #fff
skinparam NoteBorderColor #000

skinparam sequence {
	ArrowColor #000
	ActorBorderColor #000

	LifeLineBorderColor #000
	LifeLineBackgroundColor #000

	ParticipantBorderColor #000
	ParticipantBackgroundColor #fff
	ParticipantFontColor #000

	ActorBackgroundColor #000
	ActorFontColor #000

  NoteBorderColor #000
}

skinparam roundcorner 5

actor User                         as user
participant "Account Web Client"   as account
database MongoDB                   as mongo
participant "Connect"              as connect

user -> account : Wants to login

== OAuth2 client initialization ==

account -> connect : Fetch OpenID configuration
note left
The **@fwl/oauth2** package mainly provides
an abstraction for the OAuth2 flow, and a
secure way to verify JWT for **HS256** and
**RS256** algorithms
end note
connect -> account : Send back OpenID configuration and stores it in-memory

== Connect authentication flow ==

account -> connect : Redirect to **authorize_url**
note left
The **authorize_url** is built with
the **client_id**, **response_type**,
**redirect_uri** and **scope**
end note
connect -> connect : User logs in and accepts scopes
connect -> account : Send back the **authorization_code** using the **redirect_uri**
account -> connect : Send the payload
note left
**payload**
- client_id
- client_secret
- grant_type
- redirect_uri
- authorization_code
end note
connect -> account : Send back **access_token** + **refresh_token** + **id_token**
account -> mongo : Insert user in DB

== access_token verification ==

account -> connect : Fetch **JWKS**
note left
This is the flow for the RS256 flow, which
most providers uses.In the case of HS256,
all it takes is the **client_secret**.
end note
connect -> account : Send back **JWKS** which are stored in memory
account -> account : verify new **access_token**

== Refreshing the access_token ==

account -> connect : Send **refresh_token**
note left
The **access_token** has a validity period of one hour. To smooth 
the user experience, we are using a **refresh_token**, a one time
use without expiration date. To refresh the user authorization.
end note
connect -> account : Send back a new **refresh_token** and **access_token**
account -> mongo : Update User tokens

@enduml


' =============================================================================
' ======================= Identity commands and queries =======================
' =============================================================================

@startuml

skinparam NoteBackgroundColor #fff
skinparam NoteBorderColor #000

skinparam sequence {
	ArrowColor #000
	ActorBorderColor #000

	LifeLineBorderColor #000
	LifeLineBackgroundColor #000

	ParticipantBorderColor #000
	ParticipantBackgroundColor #fff
	ParticipantFontColor #000

	ActorBackgroundColor #000
	ActorFontColor #000

  NoteBorderColor #000
}

skinparam roundcorner 5

actor User                         as user
participant "Account Web Client"   as account
database MongoDB                   as mongo
participant "Connect"              as connect

== Add new identity ==

user -> account : Input identity value
activate account
account -> mongo : Insert temporary identity with the **insertTemporaryIdentity** command
note left
The command is called with the **user sub**,
the **temporary identity** and a **DB client**.
end note
account -> connect : Trigger the sendIdentityValidationCode query
note left
The query takes a **callbackUrl**, the **identity**
the **localeOverride** and the **userId**.
end note
user -> account : Input verification code
account -> connect : Trigger the checkVerificationCode query
note left
The query is called with the **verification code**
 and the **event id**
end note
account -> mongo : Query back temporary identity and verify expiration date
account -> connect : Trigger the **addIdentityToUser** mutation
note left
The mutation is called with the **user_id**,
identity **value** and **type**.
end note
account -> mongo : Delete temporary identity
deactivate account

== Delete identity ==

account -> connect : Run **removeIdentityFromUser** mutation.
note left
The mutation is called with the **user_id**,
identity **value** and **type**.
end note

== Update identity ==

note over user, connect
The update identity flow is a mix between the two above, starting with the add identity, and delete is the first sequence succeed.
end note

@enduml


' ==============================================================================
' ============================= Fetching User data =============================
' ==============================================================================

@startuml

skinparam NoteBackgroundColor #fff
skinparam NoteBorderColor #000

skinparam sequence {
	ArrowColor #000
	ActorBorderColor #000

	LifeLineBorderColor #000
	LifeLineBackgroundColor #000

	ParticipantBorderColor #000
	ParticipantBackgroundColor #fff
	ParticipantFontColor #000

	ActorBackgroundColor #000
	ActorFontColor #000

  NoteBorderColor #000
}

skinparam roundcorner 5

actor User                         as user
participant "Account Web Client"   as account
database MongoDB                   as mongo
participant "Connect"              as connect
participant "Profile API"          as profile

== Fetching User data ==

account -> connect : Fetch User identities
connect -> account : Send back User identities

opt

account -> profile : Fetch User profile infos
profile -> account : Send back User profile infos

@enduml
