<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1090px" preserveAspectRatio="none" style="width:1119px;height:1090px;" version="1.1" viewBox="0 0 1119 1090" width="1119px" zoomAndPan="magnify"><defs><filter height="300%" id="f1rni7pd5t6c0m" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="351" x2="351" y1="86.2969" y2="1003.6797"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="467" x2="467" y1="86.2969" y2="1003.6797"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="655" x2="655" y1="86.2969" y2="1003.6797"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="888" x2="888" y1="86.2969" y2="1003.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="333" y="82.9951">User</text><ellipse cx="351.5" cy="13" fill="#000000" filter="url(#f1rni7pd5t6c0m)" rx="8" ry="8" style="stroke: #000000; stroke-width: 2.0;"/><path d="M351.5,21 L351.5,48 M338.5,29 L364.5,29 M351.5,48 L338.5,63 M351.5,48 L364.5,63 " fill="none" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="333" y="1015.6748">User</text><ellipse cx="351.5" cy="1028.9766" fill="#000000" filter="url(#f1rni7pd5t6c0m)" rx="8" ry="8" style="stroke: #000000; stroke-width: 2.0;"/><path d="M351.5,1036.9766 L351.5,1063.9766 M338.5,1044.9766 L364.5,1044.9766 M351.5,1063.9766 L338.5,1078.9766 M351.5,1063.9766 L364.5,1078.9766 " fill="none" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 2.0;"/><rect fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" height="30.2969" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.5;" width="157" x="387" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="394" y="70.9951">Account Web Client</text><rect fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" height="30.2969" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.5;" width="157" x="387" y="1002.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="394" y="1022.6748">Account Web Client</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="69" x="618" y="82.9951">MongoDB</text><path d="M637.5,34 C637.5,24 655.5,24 655.5,24 C655.5,24 673.5,24 673.5,34 L673.5,60 C673.5,70 655.5,70 655.5,70 C655.5,70 637.5,70 637.5,60 L637.5,34 " fill="#FEFECE" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M637.5,34 C637.5,44 655.5,44 655.5,44 C655.5,44 673.5,44 673.5,34 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="69" x="618" y="1015.6748">MongoDB</text><path d="M637.5,1028.9766 C637.5,1018.9766 655.5,1018.9766 655.5,1018.9766 C655.5,1018.9766 673.5,1018.9766 673.5,1028.9766 L673.5,1054.9766 C673.5,1064.9766 655.5,1064.9766 655.5,1064.9766 C655.5,1064.9766 637.5,1064.9766 637.5,1054.9766 L637.5,1028.9766 " fill="#FEFECE" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M637.5,1028.9766 C637.5,1038.9766 655.5,1038.9766 655.5,1038.9766 C655.5,1038.9766 673.5,1038.9766 673.5,1028.9766 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" height="30.2969" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.5;" width="75" x="849" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="856" y="70.9951">Connect</text><rect fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" height="30.2969" rx="2.5" ry="2.5" style="stroke: #000000; stroke-width: 1.5;" width="75" x="849" y="1002.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="856" y="1022.6748">Connect</text><polygon fill="#000000" points="455.5,113.4297,465.5,117.4297,455.5,121.4297,459.5,117.4297" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="351.5" x2="461.5" y1="117.4297" y2="117.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="358.5" y="112.3638">Wants to login</text><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1104.5" x="3" y="145.9961"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="145.9961" y2="145.9961"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="148.9961" y2="148.9961"/><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="221" x="444.75" y="135.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="202" x="450.75" y="151.4966">OAuth2 client initialization</text><polygon fill="#000000" points="876.5,213.3945,886.5,217.3945,876.5,221.3945,880.5,217.3945" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="882.5" y1="217.3945" y2="217.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="474.5" y="212.3286">Fetch OpenID configuration</text><path d="M150,176.0625 L150,241.0625 A2.5,2.5 0 0 0 152.5,243.5625 L455.5,243.5625 A2.5,2.5 0 0 0 458,241.0625 L458,183.5625 L448,173.5625 L152.5,173.5625 A2.5,2.5 0 0 0 150,176.0625 " fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 1.0;"/><path d="M448,173.5625 L448,182.3125 A1.25,1.25 0 0 0 449.25,183.5625 L458,183.5625 L448,173.5625 " fill="#FFFFFF" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="156" y="190.6294">The</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="184" y="190.6294">@fwl/oauth2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="283" y="190.6294">package mainly provides</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="156" y="205.7622">an abstraction for the OAuth2 flow, and a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="156" y="220.895">secure way to verify JWT for</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="343" y="220.895">HS256</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="394" y="220.895">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="46" x="156" y="236.0278">RS256</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="206" y="236.0278">algorithms</text><polygon fill="#000000" points="478.5,270.2266,468.5,274.2266,478.5,278.2266,474.5,274.2266" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="472.5" x2="887.5" y1="274.2266" y2="274.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="484.5" y="269.1606">Send back OpenID configuration and stores it in-memory</text><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1104.5" x="3" y="302.793"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="302.793" y2="302.793"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="305.793" y2="305.793"/><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="249" x="430.75" y="292.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="436.75" y="308.2935">Connect authentification flow</text><polygon fill="#000000" points="876.5,362.625,886.5,366.625,876.5,370.625,880.5,366.625" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="882.5" y1="366.625" y2="366.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="474.5" y="361.5591">Redirect to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="548.5" y="361.5591">authorize_url</text><path d="M228,332.8594 L228,382.8594 A2.5,2.5 0 0 0 230.5,385.3594 L455.5,385.3594 A2.5,2.5 0 0 0 458,382.8594 L458,340.3594 L448,330.3594 L230.5,330.3594 A2.5,2.5 0 0 0 228,332.8594 " fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 1.0;"/><path d="M448,330.3594 L448,339.1094 A1.25,1.25 0 0 0 449.25,340.3594 L458,340.3594 L448,330.3594 " fill="#FFFFFF" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="234" y="347.4263">The</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="262" y="347.4263">authorize_url</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="366" y="347.4263">is built with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="234" y="362.5591">the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="62" x="259" y="362.5591">client_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="321" y="362.5591">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="329" y="362.5591">response_type</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="439" y="362.5591">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="234" y="377.6919">redirect_uri</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="326" y="377.6919">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="354" y="377.6919">scope</text><line style="stroke: #000000; stroke-width: 1.0;" x1="888.5" x2="930.5" y1="415.8906" y2="415.8906"/><line style="stroke: #000000; stroke-width: 1.0;" x1="930.5" x2="930.5" y1="415.8906" y2="428.8906"/><line style="stroke: #000000; stroke-width: 1.0;" x1="889.5" x2="930.5" y1="428.8906" y2="428.8906"/><polygon fill="#000000" points="899.5,424.8906,889.5,428.8906,899.5,432.8906,895.5,428.8906" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="895.5" y="410.8247">User logs in and accepts scopes</text><polygon fill="#000000" points="478.5,454.0234,468.5,458.0234,478.5,462.0234,474.5,458.0234" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="472.5" x2="887.5" y1="458.0234" y2="458.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="484.5" y="452.9575">Send back the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="579.5" y="452.9575">authorization_code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="730.5" y="452.9575">using the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="793.5" y="452.9575">redirect_uri</text><polygon fill="#000000" points="876.5,525.9883,886.5,529.9883,876.5,533.9883,880.5,529.9883" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="882.5" y1="529.9883" y2="529.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="474.5" y="524.9224">Send the payload</text><path d="M306,473.5234 L306,568.5234 A2.5,2.5 0 0 0 308.5,571.0234 L455.5,571.0234 A2.5,2.5 0 0 0 458,568.5234 L458,481.0234 L448,471.0234 L308.5,471.0234 A2.5,2.5 0 0 0 306,473.5234 " fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 1.0;"/><path d="M448,471.0234 L448,479.7734 A1.25,1.25 0 0 0 449.25,481.0234 L458,481.0234 L448,471.0234 " fill="#FFFFFF" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58" x="312" y="488.0903">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="312" y="503.2231">- client_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="312" y="518.356">- client_secret</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="312" y="533.4888">- grant_type</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="312" y="548.6216">- redirect_uri</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="312" y="563.7544">- authorization_code</text><polygon fill="#000000" points="478.5,597.9531,468.5,601.9531,478.5,605.9531,474.5,601.9531" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="472.5" x2="887.5" y1="601.9531" y2="601.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="484.5" y="596.8872">Send back</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="554.5" y="596.8872">access_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="660.5" y="596.8872">+</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="674.5" y="596.8872">refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="786.5" y="596.8872">+</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="65" x="800.5" y="596.8872">id_token</text><polygon fill="#000000" points="643.5,627.0859,653.5,631.0859,643.5,635.0859,647.5,631.0859" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="649.5" y1="631.0859" y2="631.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="105" x="474.5" y="626.02">Insert user in DB</text><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1104.5" x="3" y="659.6523"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="659.6523" y2="659.6523"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="662.6523" y2="662.6523"/><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="213" x="448.75" y="649.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="194" x="454.75" y="665.1528">access_token verification</text><polygon fill="#000000" points="876.5,719.4844,886.5,723.4844,876.5,727.4844,880.5,723.4844" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="882.5" y1="723.4844" y2="723.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="474.5" y="718.4185">Fetch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="513.5" y="718.4185">JWKS</text><path d="M166,689.7188 L166,739.7188 A2.5,2.5 0 0 0 168.5,742.2188 L455.5,742.2188 A2.5,2.5 0 0 0 458,739.7188 L458,697.2188 L448,687.2188 L168.5,687.2188 A2.5,2.5 0 0 0 166,689.7188 " fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 1.0;"/><path d="M448,687.2188 L448,695.9688 A1.25,1.25 0 0 0 449.25,697.2188 L458,697.2188 L448,687.2188 " fill="#FFFFFF" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="172" y="704.2856">This is the flow for the RS256 flow, which</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="172" y="719.4185">most providers uses.In the case of HS256,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="172" y="734.5513">all it takes is the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="280" y="734.5513">client_secret</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="734.5513">.</text><polygon fill="#000000" points="478.5,768.75,468.5,772.75,478.5,776.75,474.5,772.75" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="472.5" x2="887.5" y1="772.75" y2="772.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="484.5" y="767.6841">Send back</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="554.5" y="767.6841">JWKS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="596.5" y="767.6841">which are stored in memory</text><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="509.5" y1="801.8828" y2="801.8828"/><line style="stroke: #000000; stroke-width: 1.0;" x1="509.5" x2="509.5" y1="801.8828" y2="814.8828"/><line style="stroke: #000000; stroke-width: 1.0;" x1="468.5" x2="509.5" y1="814.8828" y2="814.8828"/><polygon fill="#000000" points="478.5,810.8828,468.5,814.8828,478.5,818.8828,474.5,814.8828" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="474.5" y="796.8169">verify new</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="546.5" y="796.8169">access_token</text><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="3" style="stroke: #EEEEEE; stroke-width: 1.0;" width="1104.5" x="3" y="843.4492"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="843.4492" y2="843.4492"/><line style="stroke: #000000; stroke-width: 1.0;" x1="3" x2="1107.5" y1="846.4492" y2="846.4492"/><rect fill="#EEEEEE" filter="url(#f1rni7pd5t6c0m)" height="23.1328" style="stroke: #000000; stroke-width: 2.0;" width="238" x="436.25" y="832.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="219" x="442.25" y="848.9497">Refreshing the access_token</text><polygon fill="#000000" points="876.5,903.2813,886.5,907.2813,876.5,911.2813,880.5,907.2813" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="882.5" y1="907.2813" y2="907.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="474.5" y="902.2153">Send</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="510.5" y="902.2153">refresh_token</text><path d="M8,873.5156 L8,923.5156 A2.5,2.5 0 0 0 10.5,926.0156 L456.5,926.0156 A2.5,2.5 0 0 0 459,923.5156 L459,881.0156 L449,871.0156 L10.5,871.0156 A2.5,2.5 0 0 0 8,873.5156 " fill="#FFFFFF" filter="url(#f1rni7pd5t6c0m)" style="stroke: #000000; stroke-width: 1.0;"/><path d="M449,871.0156 L449,879.7656 A1.25,1.25 0 0 0 450.25,881.0156 L459,881.0156 L449,871.0156 " fill="#FFFFFF" style="stroke: #000000; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="14" y="888.0825">The</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="42" y="888.0825">access_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="148" y="888.0825">has a validity periode of one hour. To smooth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="14" y="903.2153">the user experience, we are using a</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="248" y="903.2153">refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="356" y="903.2153">, a one time</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="399" x="14" y="918.3481">use without expiration date. To refresh the user authorization.</text><polygon fill="#000000" points="478.5,952.5469,468.5,956.5469,478.5,960.5469,474.5,956.5469" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="472.5" x2="887.5" y1="956.5469" y2="956.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="484.5" y="951.481">Send back a new</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="597.5" y="951.481">refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="709.5" y="951.481">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="737.5" y="951.481">access_token</text><polygon fill="#000000" points="643.5,981.6797,653.5,985.6797,643.5,989.6797,647.5,985.6797" style="stroke: #000000; stroke-width: 1.0;"/><line style="stroke: #000000; stroke-width: 1.0;" x1="467.5" x2="649.5" y1="985.6797" y2="985.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="474.5" y="980.6138">Update User tokens</text><!--MD5=[0e60345644984d7a8ba84c3b8b99328d]
@startuml
skinparam NoteBackgroundColor #fff
skinparam NoteBorderColor #000

skinparam sequence {
	ArrowColor #000
	ActorBorderColor #000

	LifeLineBorderColor #000
	LifeLineBackgroundColor #000

	ParticipantBorderColor #000
	ParticipantBackgroundColor #fff
	ParticipantFontColor #000

	ActorBackgroundColor #000
	ActorFontColor #000

        NoteBorderColor #000
}

skinparam roundcorner 5

actor User                         as user
participant "Account Web Client"   as account
database MongoDB                   as mongo
participant "Connect"              as connect

user -> account : Wants to login

== OAuth2 client initialization ==

account -> connect : Fetch OpenID configuration
note left
The **@fwl/oauth2** package mainly provides
an abstraction for the OAuth2 flow, and a
secure way to verify JWT for **HS256** and
**RS256** algorithms
end note
connect -> account : Send back OpenID configuration and stores it in-memory

== Connect authentification flow ==

account -> connect : Redirect to **authorize_url**
note left
The **authorize_url** is built with
the **client_id**, **response_type**,
**redirect_uri** and **scope**
end note
connect -> connect : User logs in and accepts scopes
connect -> account : Send back the **authorization_code** using the **redirect_uri**
account -> connect : Send the payload
note left
**payload**
- client_id
- client_secret
- grant_type
- redirect_uri
- authorization_code
end note
connect -> account : Send back **access_token** + **refresh_token** + **id_token**
account -> mongo : Insert user in DB

== access_token verification ==

account -> connect : Fetch **JWKS**
note left
This is the flow for the RS256 flow, which
most providers uses.In the case of HS256,
all it takes is the **client_secret**.
end note
connect -> account : Send back **JWKS** which are stored in memory
account -> account : verify new **access_token**

== Refreshing the access_token ==

account -> connect : Send **refresh_token**
note left
The **access_token** has a validity periode of one hour. To smooth 
the user experience, we are using a **refresh_token**, a one time
use without expiration date. To refresh the user authorization.
end note
connect -> account : Send back a new **refresh_token** and **access_token**
account -> mongo : Update User tokens
@enduml

PlantUML version 1.2020.18beta4(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>