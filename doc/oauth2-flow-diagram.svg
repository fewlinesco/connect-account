<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1266px" preserveAspectRatio="none" style="width:1120px;height:1266px;" version="1.1" viewBox="0 0 1120 1266" width="1120px" zoomAndPan="magnify"><defs><filter height="300%" id="f46aj0m8ns9c2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="357" x2="357" y1="88.2969" y2="1182.6094"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="473" x2="473" y1="88.2969" y2="1182.6094"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="770.5" x2="770.5" y1="88.2969" y2="1182.6094"/><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="894" x2="894" y1="88.2969" y2="1182.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="339" y="84.9951">User</text><ellipse cx="357.5" cy="15" fill="#000000" filter="url(#f46aj0m8ns9c2)" rx="8" ry="8" style="stroke:#000000;stroke-width:2.0;"/><path d="M357.5,23 L357.5,50 M344.5,31 L370.5,31 M357.5,50 L344.5,65 M357.5,50 L370.5,65 " fill="none" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="339" y="1194.6045">User</text><ellipse cx="357.5" cy="1207.9063" fill="#000000" filter="url(#f46aj0m8ns9c2)" rx="8" ry="8" style="stroke:#000000;stroke-width:2.0;"/><path d="M357.5,1215.9063 L357.5,1242.9063 M344.5,1223.9063 L370.5,1223.9063 M357.5,1242.9063 L344.5,1257.9063 M357.5,1242.9063 L370.5,1257.9063 " fill="none" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:2.0;"/><rect fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.5;" width="157" x="393" y="53"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="400" y="72.9951">Account Web Client</text><rect fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.5;" width="157" x="393" y="1181.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="143" x="400" y="1201.6045">Account Web Client</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="727.5" y="84.9951">DynamoDB</text><path d="M752.5,36 C752.5,26 770.5,26 770.5,26 C770.5,26 788.5,26 788.5,36 L788.5,62 C788.5,72 770.5,72 770.5,72 C770.5,72 752.5,72 752.5,62 L752.5,36 " fill="#FEFECE" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.5;"/><path d="M752.5,36 C752.5,46 770.5,46 770.5,46 C770.5,46 788.5,46 788.5,36 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="727.5" y="1194.6045">DynamoDB</text><path d="M752.5,1207.9063 C752.5,1197.9063 770.5,1197.9063 770.5,1197.9063 C770.5,1197.9063 788.5,1197.9063 788.5,1207.9063 L788.5,1233.9063 C788.5,1243.9063 770.5,1243.9063 770.5,1243.9063 C770.5,1243.9063 752.5,1243.9063 752.5,1233.9063 L752.5,1207.9063 " fill="#FEFECE" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.5;"/><path d="M752.5,1207.9063 C752.5,1217.9063 770.5,1217.9063 770.5,1217.9063 C770.5,1217.9063 788.5,1217.9063 788.5,1207.9063 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><rect fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.5;" width="75" x="855" y="53"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="862" y="72.9951">Connect</text><rect fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" height="30.2969" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:1.5;" width="75" x="855" y="1181.6094"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="61" x="862" y="1201.6045">Connect</text><polygon fill="#000000" points="461.5,115.4297,471.5,119.4297,461.5,123.4297,465.5,119.4297" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="357.5" x2="467.5" y1="119.4297" y2="119.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="364.5" y="114.3638">Wants to login</text><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1113.5" x="0" y="147.9961"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="147.9961" y2="147.9961"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="150.9961" y2="150.9961"/><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="221" x="446.25" y="137.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="202" x="452.25" y="153.4966">OAuth2 client initialization</text><polygon fill="#000000" points="882.5,215.3945,892.5,219.3945,882.5,223.3945,886.5,219.3945" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="888.5" y1="219.3945" y2="219.3945"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="480.5" y="214.3286">Fetch OpenID configuration</text><path d="M156,178.0625 L156,243.0625 A2.5,2.5 0 0 0 158.5,245.5625 L461.5,245.5625 A2.5,2.5 0 0 0 464,243.0625 L464,185.5625 L454,175.5625 L158.5,175.5625 A2.5,2.5 0 0 0 156,178.0625 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M454,175.5625 L454,184.3125 A1.25,1.25 0 0 0 455.25,185.5625 L464,185.5625 L454,175.5625 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="162" y="192.6294">The</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="95" x="190" y="192.6294">@fwl/oauth2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="289" y="192.6294">package mainly provides</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="266" x="162" y="207.7622">an abstraction for the OAuth2 flow, and a</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="162" y="222.895">secure way to decrypt/verify</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="351" y="222.895">JWE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="13" x="383" y="222.895">or</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="162" y="238.0278">JWS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="194" y="238.0278">for</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="216" y="238.0278">HS256</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="267" y="238.0278">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="46" x="295" y="238.0278">RS256</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="345" y="238.0278">algorithms.</text><polygon fill="#000000" points="484.5,272.2266,474.5,276.2266,484.5,280.2266,480.5,276.2266" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="478.5" x2="893.5" y1="276.2266" y2="276.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="364" x="490.5" y="271.1606">Send back OpenID configuration and stores it in-memory</text><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1113.5" x="0" y="304.793"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="304.793" y2="304.793"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="307.793" y2="307.793"/><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="238" x="437.75" y="294.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="219" x="443.75" y="310.2935">Connect authentication flow</text><polygon fill="#000000" points="882.5,364.625,892.5,368.625,882.5,372.625,886.5,368.625" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="888.5" y1="368.625" y2="368.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="480.5" y="363.5591">Redirect to</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="554.5" y="363.5591">authorize_url</text><path d="M234,334.8594 L234,384.8594 A2.5,2.5 0 0 0 236.5,387.3594 L461.5,387.3594 A2.5,2.5 0 0 0 464,384.8594 L464,342.3594 L454,332.3594 L236.5,332.3594 A2.5,2.5 0 0 0 234,334.8594 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M454,332.3594 L454,341.1094 A1.25,1.25 0 0 0 455.25,342.3594 L464,342.3594 L454,332.3594 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="240" y="349.4263">The</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="100" x="268" y="349.4263">authorize_url</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="372" y="349.4263">is built with</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="240" y="364.5591">the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="62" x="265" y="364.5591">client_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="327" y="364.5591">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="335" y="364.5591">response_type</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="445" y="364.5591">,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="240" y="379.6919">redirect_uri</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="332" y="379.6919">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="360" y="379.6919">scope</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="404" y="379.6919">.</text><line style="stroke:#000000;stroke-width:1.0;" x1="894.5" x2="936.5" y1="417.8906" y2="417.8906"/><line style="stroke:#000000;stroke-width:1.0;" x1="936.5" x2="936.5" y1="417.8906" y2="430.8906"/><line style="stroke:#000000;stroke-width:1.0;" x1="895.5" x2="936.5" y1="430.8906" y2="430.8906"/><polygon fill="#000000" points="905.5,426.8906,895.5,430.8906,905.5,434.8906,901.5,430.8906" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="901.5" y="412.8247">User logs in and accepts scopes</text><polygon fill="#000000" points="484.5,456.0234,474.5,460.0234,484.5,464.0234,480.5,460.0234" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="478.5" x2="893.5" y1="460.0234" y2="460.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="490.5" y="454.9575">Send back the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="147" x="585.5" y="454.9575">authorization_code</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="59" x="736.5" y="454.9575">using the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88" x="799.5" y="454.9575">redirect_uri</text><polygon fill="#000000" points="882.5,520.4219,892.5,524.4219,882.5,528.4219,886.5,524.4219" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="888.5" y1="524.4219" y2="524.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="480.5" y="519.356">Send the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58" x="541.5" y="519.356">payload</text><path d="M312,475.5234 L312,555.5234 A2.5,2.5 0 0 0 314.5,558.0234 L461.5,558.0234 A2.5,2.5 0 0 0 464,555.5234 L464,483.0234 L454,473.0234 L314.5,473.0234 A2.5,2.5 0 0 0 312,475.5234 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M454,473.0234 L454,481.7734 A1.25,1.25 0 0 0 455.25,483.0234 L464,483.0234 L454,473.0234 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="318" y="490.0903">- client_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="318" y="505.2231">- client_secret</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="318" y="520.356">- grant_type</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="81" x="318" y="535.4888">- redirect_uri</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="318" y="550.6216">- authorization_code</text><polygon fill="#000000" points="484.5,584.8203,474.5,588.8203,484.5,592.8203,480.5,588.8203" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="478.5" x2="893.5" y1="588.8203" y2="588.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="490.5" y="583.7544">Send back</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="560.5" y="583.7544">access_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="666.5" y="583.7544">+</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="680.5" y="583.7544">refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="792.5" y="583.7544">+</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="65" x="806.5" y="583.7544">id_token</text><polygon fill="#000000" points="758.5,626.5195,768.5,630.5195,758.5,634.5195,762.5,630.5195" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="764.5" y1="630.5195" y2="630.5195"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="480.5" y="625.4536">Insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="520.5" y="625.4536">user data</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="597.5" y="625.4536">in DB</text><path d="M339,604.3203 L339,639.3203 A2.5,2.5 0 0 0 341.5,641.8203 L461.5,641.8203 A2.5,2.5 0 0 0 464,639.3203 L464,611.8203 L454,601.8203 L341.5,601.8203 A2.5,2.5 0 0 0 339,604.3203 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M454,601.8203 L454,610.5703 A1.25,1.25 0 0 0 455.25,611.8203 L464,611.8203 L454,601.8203 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="345" y="618.8872">- sub (hash key)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="345" y="634.02">- refresh_token</text><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="515.5" y1="678.2852" y2="678.2852"/><line style="stroke:#000000;stroke-width:1.0;" x1="515.5" x2="515.5" y1="678.2852" y2="691.2852"/><line style="stroke:#000000;stroke-width:1.0;" x1="474.5" x2="515.5" y1="691.2852" y2="691.2852"/><polygon fill="#000000" points="484.5,687.2852,474.5,691.2852,484.5,695.2852,480.5,691.2852" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="480.5" y="673.2192">Initialize</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86" x="535.5" y="673.2192">UserCookie</text><path d="M347,658.5859 L347,693.5859 A2.5,2.5 0 0 0 349.5,696.0859 L461.5,696.0859 A2.5,2.5 0 0 0 464,693.5859 L464,666.0859 L454,656.0859 L349.5,656.0859 A2.5,2.5 0 0 0 347,658.5859 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M454,656.0859 L454,664.8359 A1.25,1.25 0 0 0 455.25,666.0859 L464,666.0859 L454,656.0859 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="353" y="673.1528">- sub</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="353" y="688.2856">- access_token</text><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1113.5" x="0" y="725.918"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="725.918" y2="725.918"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="728.918" y2="728.918"/><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="213" x="450.25" y="715.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="194" x="456.25" y="731.4185">access_token verification</text><polygon fill="#000000" points="882.5,785.75,892.5,789.75,882.5,793.75,886.5,789.75" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="888.5" y1="789.75" y2="789.75"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="480.5" y="784.6841">Fetch</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="519.5" y="784.6841">JWKS</text><path d="M162,755.9844 L162,805.9844 A2.5,2.5 0 0 0 164.5,808.4844 L461.5,808.4844 A2.5,2.5 0 0 0 464,805.9844 L464,763.4844 L454,753.4844 L164.5,753.4844 A2.5,2.5 0 0 0 162,755.9844 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M454,753.4844 L454,762.2344 A1.25,1.25 0 0 0 455.25,763.4844 L464,763.4844 L454,753.4844 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="168" y="770.5513">This is the flow for the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="79" x="315" y="770.5513">RS256 JWE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="394" y="770.5513">, which</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="168" y="785.6841">most providers uses. In the case of</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="398" y="785.6841">HS256</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="445" y="785.6841">,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="168" y="800.8169">all it takes is the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="276" y="800.8169">client_secret</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="374" y="800.8169">.</text><polygon fill="#000000" points="484.5,835.0156,474.5,839.0156,484.5,843.0156,480.5,839.0156" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="478.5" x2="893.5" y1="839.0156" y2="839.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="490.5" y="833.9497">Send back</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="38" x="560.5" y="833.9497">JWKS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="602.5" y="833.9497">which are stored in memory</text><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="515.5" y1="868.1484" y2="868.1484"/><line style="stroke:#000000;stroke-width:1.0;" x1="515.5" x2="515.5" y1="868.1484" y2="881.1484"/><line style="stroke:#000000;stroke-width:1.0;" x1="474.5" x2="515.5" y1="881.1484" y2="881.1484"/><polygon fill="#000000" points="484.5,877.1484,474.5,881.1484,484.5,885.1484,480.5,881.1484" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="480.5" y="863.0825">decrypt and verify received</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="661.5" y="863.0825">access_token</text><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1113.5" x="0" y="909.7148"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="909.7148" y2="909.7148"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="1113.5" y1="912.7148" y2="912.7148"/><rect fill="#EEEEEE" filter="url(#f46aj0m8ns9c2)" height="23.1328" style="stroke:#000000;stroke-width:2.0;" width="238" x="437.75" y="899.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="219" x="443.75" y="915.2153">Refreshing the access_token</text><polygon fill="#000000" points="882.5,969.5469,892.5,973.5469,882.5,977.5469,886.5,973.5469" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="888.5" y1="973.5469" y2="973.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="480.5" y="968.481">Send</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="516.5" y="968.481">refresh_token</text><path d="M5,939.7813 L5,989.7813 A2.5,2.5 0 0 0 7.5,992.2813 L462.5,992.2813 A2.5,2.5 0 0 0 465,989.7813 L465,947.2813 L455,937.2813 L7.5,937.2813 A2.5,2.5 0 0 0 5,939.7813 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M455,937.2813 L455,946.0313 A1.25,1.25 0 0 0 456.25,947.2813 L465,947.2813 L455,937.2813 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="11" y="954.3481">The</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="39" y="954.3481">access_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="145" y="954.3481">has a validity period of one hour. To smooth</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="11" y="969.481">the user experience, we are using a</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="245" y="969.481">refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="353" y="969.481">, a one time</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="11" y="984.6138">use token without expiration date. To refresh the user authorization.</text><polygon fill="#000000" points="484.5,1054.0781,474.5,1058.0781,484.5,1062.0781,480.5,1058.0781" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="478.5" x2="893.5" y1="1058.0781" y2="1058.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="490.5" y="1053.0122">Send back a new</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="603.5" y="1053.0122">refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="715.5" y="1053.0122">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="743.5" y="1053.0122">access_token</text><path d="M256,1009.1797 L256,1089.1797 A2.5,2.5 0 0 0 258.5,1091.6797 L461.5,1091.6797 A2.5,2.5 0 0 0 464,1089.1797 L464,1016.6797 L454,1006.6797 L258.5,1006.6797 A2.5,2.5 0 0 0 256,1009.1797 " fill="#FFFFFF" filter="url(#f46aj0m8ns9c2)" style="stroke:#000000;stroke-width:1.0;"/><path d="M454,1006.6797 L454,1015.4297 A1.25,1.25 0 0 0 455.25,1016.6797 L464,1016.6797 L454,1006.6797 " fill="#FFFFFF" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="262" y="1023.7466">- client_id</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="262" y="1038.8794">- client_secret</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="262" y="1054.0122">- refresh_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="262" y="1069.145">- grant_type: "refresh_token"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="262" y="1084.2778">- scope</text><polygon fill="#000000" points="758.5,1118.4766,768.5,1122.4766,758.5,1126.4766,762.5,1122.4766" style="stroke:#000000;stroke-width:1.0;"/><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="764.5" y1="1122.4766" y2="1122.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="480.5" y="1117.4106">Update</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="530.5" y="1117.4106">refresh_token</text><line style="stroke:#000000;stroke-width:1.0;" x1="473.5" x2="515.5" y1="1151.6094" y2="1151.6094"/><line style="stroke:#000000;stroke-width:1.0;" x1="515.5" x2="515.5" y1="1151.6094" y2="1164.6094"/><line style="stroke:#000000;stroke-width:1.0;" x1="474.5" x2="515.5" y1="1164.6094" y2="1164.6094"/><polygon fill="#000000" points="484.5,1160.6094,474.5,1164.6094,484.5,1168.6094,480.5,1164.6094" style="stroke:#000000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="480.5" y="1146.5435">Update</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="530.5" y="1146.5435">access_token</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="11" x="636.5" y="1146.5435">in</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86" x="651.5" y="1146.5435">UserCookie</text><!--MD5=[ff673b214061fc46bfdd8ebdd28e0ee8]
@startuml
skinparam NoteBackgroundColor #fff
skinparam NoteBorderColor #000

skinparam sequence {
	ArrowColor #000
	ActorBorderColor #000

	LifeLineBorderColor #000
	LifeLineBackgroundColor #000

	ParticipantBorderColor #000
	ParticipantBackgroundColor #fff
	ParticipantFontColor #000

	ActorBackgroundColor #000
	ActorFontColor #000

  NoteBorderColor #000
}

skinparam roundcorner 5

actor User                         as user
participant "Account Web Client"   as account
database DynamoDB                  as dynamo
participant "Connect"              as connect

user -> account : Wants to login

== OAuth2 client initialization ==

account -> connect : Fetch OpenID configuration
note left
The **@fwl/oauth2** package mainly provides
an abstraction for the OAuth2 flow, and a
secure way to decrypt/verify **JWE** or 
**JWS** for **HS256** and **RS256** algorithms.
end note
connect -> account : Send back OpenID configuration and stores it in-memory

== Connect authentication flow ==

account -> connect : Redirect to **authorize_url**
note left
The **authorize_url** is built with
the **client_id**, **response_type**,
**redirect_uri** and **scope**.
end note
connect -> connect : User logs in and accepts scopes
connect -> account : Send back the **authorization_code** using the **redirect_uri**
account -> connect : Send the **payload**
note left
- client_id
- client_secret
- grant_type
- redirect_uri
- authorization_code
end note
connect -> account : Send back **access_token** + **refresh_token** + **id_token**
account -> dynamo : Insert **user data** in DB
note left
- sub (hash key)
- refresh_token
end note
account -> account : Initialize **UserCookie**
note left
- sub
- access_token
end note

== access_token verification ==

account -> connect : Fetch **JWKS**
note left
This is the flow for the **RS256 JWE**, which
most providers uses. In the case of **HS256**,
all it takes is the **client_secret**.
end note
connect -> account : Send back **JWKS** which are stored in memory
account -> account : decrypt and verify received **access_token**

== Refreshing the access_token ==

account -> connect : Send **refresh_token**
note left
The **access_token** has a validity period of one hour. To smooth 
the user experience, we are using a **refresh_token**, a one time
use token without expiration date. To refresh the user authorization.
end note
connect -> account : Send back a new **refresh_token** and **access_token**
note left
- client_id
- client_secret
- refresh_token
- grant_type: "refresh_token"
- scope
end note
account -> dynamo : Update **refresh_token**
account -> account : Update **access_token** in **UserCookie**
@enduml

PlantUML version 1.2020.22(Sun Dec 06 09:36:27 UTC 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>